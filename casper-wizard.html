<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-wizard.
  -
  - casper-wizard is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-wizard  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-wizard.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-common-ui/casper-i18n-behavior.html">
<link rel="import" href="../casper-wizard/casper-wizard-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-upload-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-progress-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-status-page.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../iron-fit-behavior/iron-fit-behavior.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../casper-icons/casper-icons.html">

<dom-module id="casper-wizard">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
    </style>
  </template>

  <script>
    /**
     * `casper-wizard`
     * Wizard a container for simple dialogs with the infamous prev-next buttons
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperWizard extends Polymer.mixinBehaviors([Polymer.IronOverlayBehavior, Polymer.IronFitBehavior], Casper.I18n(Polymer.Element)) {
      
      static get is () { 
        return 'casper-wizard'; 
      }

      ready () {
        super.ready();
        // console.log("wizard ready", this);

        let style = document.createElement('style');
        style.type = 'text/css';
        style.innerHTML = `
            paper-icon-button {
              width: 60px;
              height: 60px;
            }
            paper-icon-button[disabled] {
              color: #888;
            }
            .page-container {
              overflow-x: hidden;
              width: 800px;
              height: 478px;
              background-color: black;
              position: relative;
              border-radius: 0px 0px 10px 10px;
            }
            .title {
              top: 0px;
              left: 0px;
              background-color: var(--primary-color);
              border-radius: 10px 10px 0px 0px;
              color: white;
              line-height: 42px;
              height: 42px;
              font-size: 18px;
              font-weight: bold;
              padding: 0px 48px 0px 12px;
              margin: 0px;
              text-overflow: ellipsis;
              position: relative;
              white-space: nowrap;
              overflow: hidden;
            }
            .page-tabs {
              top: 0px;
              left: 0px;
              height: 100%;
              position: absolute;
            }
            .page-tab {
              top: 0px;
              position: absolute;
              width: 30px;
              height: 520px;
              background-color: black;
              color: white;
              font-size: 20px;
              font-weight: bold;
            }
            .tab-label {
              position: absolute;
              bottom: 20px;
              color: white;
              font-weight: bold;
              font-size: 18px;
            }
            .wizard-next-button {
              position: absolute; 
              right: 0px; 
              bottom: 0px;
              color: var(--primary-color);
              z-index: 4;
            }
            .wizard-previous-button {
              position: absolute; 
              right: 50px;
              bottom: 0px;
              color: var(--primary-color);
              z-index: 4;
            }
            .wizard-close-button {
              width: 50px;
              height: 50px;
              position: absolute;
              top: -4px;
              right: 0px;
              color: #FFF;
              z-index: 4;
            }
            .page  {
              top: 0px;
              height: 100%;
              position: absolute;
              -moz-transform: translateZ(0);
              -ms-transform: translateZ(0);
              -o-transform: translateZ(0);
              transform: translateZ(0);
              background-color: #fff;
            }
            .slidein {
              -moz-transition: transform 1s ease-in-out;
              -webkit-transition: transform 1s ease-in-out;
              -o-transition: transform 1s ease-in-out;
              transition: transform 1s ease-in-out;
            }
            .tabslide {
              -moz-transform: translateZ(0);
              -ms-transform: translateZ(0);
              -o-transform: translateZ(0);
              transform: translateZ(0);
              -moz-transition: left 0.5s ease-in-out;
              -webkit-transition: left 0.5s ease-in-out;
              -o-transition: left 0.5s ease-in-out;
              transition: left 0.5s ease-in-out;
            }
            .fadein {
              opacity: 0;
              transition: opacity 2s ease-in-out;
            }
            .left {
              transform: translate3d(-100%, 0, 0);
            }
            .right {
              transform: translate3d(100%, 0, 0);
            }`;
        this.shadowRoot.appendChild(style);

        this._pageTabs = document.createElement('div');
        this._pageTabs.classList.add('page-tabs');
        this._pageTabs.classList.add('tabslide');
        this.shadowRoot.appendChild(this._pageTabs);


        this._title = document.createElement('div');
        this._title.classList.add('title');
        this.shadowRoot.appendChild(this._title);

        this._pageContainer = document.createElement('div');
        this._pageContainer.classList.add('page-container');
        this.shadowRoot.appendChild(this._pageContainer);

        this._pageIndex = 0;
        this._boundJobNotification = this._onJobNotification.bind(this);

        this._pages = this.shadowRoot.querySelectorAll('casper-wizard-page');
        for ( let idx = 0; idx < this._pages.length; idx++ ) {
          const page = this._pages[idx];
          page.classList.add('page');
          this._pageContainer.appendChild(page);
        }

        this._prevButton = document.createElement('paper-icon-button');
        this._prevButton.icon = 'casper-icons:arrow-left';
        this._prevButton.addEventListener('tap', e => this._gotoPreviousPage(e));
        this._prevButton.classList = 'wizard-previous-button';
        this.shadowRoot.appendChild(this._prevButton);

        this._nextButton = document.createElement('paper-icon-button');
        this._nextButton.icon = 'casper-icons:arrow-right';
        this._nextButton.addEventListener('tap', e => this._gotoNextPage(e));
        this._nextButton.classList = 'wizard-next-button';
        this.shadowRoot.appendChild(this._nextButton);

        this._closeButton = document.createElement('paper-icon-button');
        this._closeButton.icon = 'casper-icons:close';
        this._closeButton.addEventListener('tap', e => this._closePage(e));
        this._closeButton.classList = 'wizard-close-button';
        this.shadowRoot.appendChild(this._closeButton);

        this._createTabs();
        this._adjustPageClasses();
        this._updateWizardButtons();
      }

      //***************************************************************************************//
      //                                                                                       //
      //                      ~~~ API to be used by the Wizards of Oz ~~~                      //
      //                                                                                       //
      //***************************************************************************************//

      setOptions (options) {
        this.options = JSON.parse(JSON.stringify(options));
      }

      setTitle (title) {
        this._title.textContent = title;
      }

      setPageTitle (idx, title) {
        this._pages[idx].pageTitle = title;
      }

      nextPage () {
        if ( this._pageIndex < this._pages.length - 1 ) {
          this._activatePage(this._pageIndex + 1);
        }  
      }

      previousPage () {
        if ( this._pageIndex >= 1 ) {
          this._activatePage(this._pageIndex - 1);
        }
      }

      submitJob (job, timeout) {
        this.showProgressPage();
        job.validity          = timeout;
        job.entity_id         = null;
        job.user_id           = null;
        job.sharded_schema    = null;   // TODO move this to socket
        job.company_schema    = null;
        job.accounting_schema = null; 
        job.accounting_prefix = null;
        this.socket.submitJob(job, this._submitJobResponse.bind(this), { validity: timeout, ttr: timeout, timeout: timeout});
      }

      showProgressPage () {
        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
          this._statusPage.style.opacity = 0.0;
        }  
        // ... create page if needed ...
        if ( this._progressPage === undefined ) {
          this._progressPage = document.createElement('casper-wizard-progress-page');
          this._progressPage.title = 'Progresso em curso';
          this._progressPage.classList.add('fadein');
          this._pageContainer.appendChild(this._progressPage);
        }

        // ... show progress page
        this._progressPage.style.zIndex = '3';
        this._progressPage.style.display = 'flex';
        this._progressPage.style.opacity = 1.0;
        this._prevButton.disabled = false;
        this._nextButton.disabled = true;
      }

      showStatusPage (notification) {
        // ... hide current pages ...
        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
          this._progressPage.style.opacity = 0.0;
        }        
        // ... create page if needed ...
        if ( this._statusPage === undefined ) {
          this._statusPage  = document.createElement('casper-wizard-status-page');
          this._statusPage.classList.add('fadein');
          this._pageContainer.appendChild(this._statusPage);
        }

        // ... set message and or icon ...
        this._statusPage.message = this.i18n.apply(this, notification.message);
        if ( notification.title !== undefined ) {
          this._statusPage.title = notification.title;
        }
        if ( notification.response !== undefined && notification.response.stash_icon !== undefined ) {
          this._statusPage.icon = notification.response.stash_icon;
        }

        // show status page
        this._statusPage.style.zIndex  = '3';
        this._statusPage.style.display = 'flex';
        this._statusPage.style.opacity = 1.0;
        this._prevButton.disabled = false;
        this._nextButton.disabled = true;
      }

      //***************************************************************************************//
      //                                                                                       //
      //                    ~~~ Internals of the underworld implementaion ~~~                  //
      //                                                                                       //
      //***************************************************************************************//

      _gotoPreviousPage (event) {
        
        if ( this._slideTimeout !== undefined ) {
          return;
        }

        if ( this._statusPage !== undefined && this._statusPage.style.display !== 'none' ) {
          this._activatePage(this._pageIndex);
        } else {
          if ( this._pageIndex >= 1 ) {
            if ( typeof this['previousOnPage' + this._pageIndex] === 'function' ) {
              this['previousOnPage' + this._pageIndex].apply(this);
            } else {
              this._activatePage(this._pageIndex - 1);
            }
          }
        }
      }

      _gotoNextPage (event) {

        if ( this._slideTimeout !== undefined ) {
          return;
        }

        if ( this._pageIndex < this._pages.length - 1 ) {
          if ( typeof this['nextOnPage' + this._pageIndex] === 'function' ) {
            this['nextOnPage' + this._pageIndex].apply(this);
          } else {
            this._activatePage(this._pageIndex + 1);
          }
        } else {
          if ( typeof this['nextOnPage' + (this._pages.length - 1)] === 'function' ) {
            this['nextOnPage' + (this._pages.length - 1)].apply(this);
          } else {
            this.close();
          }
        }
      }

      _activatePage (pageIndex) {

        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
        }
        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
        }

        this._pages[this._pageIndex].style.opacity = 0.8;

        const page = this._pages[pageIndex];
        page.style.zIndex = '2';
        page.style.opacity = 1.0;
        page.classList.add('slidein');
        page.classList.remove('left');
        page.classList.remove('right');
        this._pageIndex = pageIndex;
        this._pageTabs.style.left = -30 * this._pageIndex + 'px';
        this._slideTimeout = setTimeout(() => this._pageSlideTimer(), 1 * 1000);
      }

      _pageSlideTimer (event) {
        this._slideTimeout = undefined;
        this._adjustPageClasses();
        this._updateWizardButtons();
      }

      _adjustPageClasses () {
        for ( let idx = 0; idx < this._pages.length; idx++ ) {
          const page = this._pages[idx];
            
          page.classList.remove('slidein');
          if ( idx <  this._pageIndex ) {
            page.classList.add('left'); 
            page.style.zIndex = '0';
          } else if ( idx > this._pageIndex ) {
            page.classList.add('right'); 
            page.style.zIndex = '0';
          } else {
            page.style.zIndex = '1';
          }
        }
      }

      _createTabs () {
        let opa = 0.4;
        let r   = 0;

        this._pageTabs.style.width = 800 + 30 * (this._pages.length - 1) + 'px';
        for ( let idx = this._pages.length; idx > 1; idx-- ) {
          let tab = document.createElement('div');
          let lbl = document.createElement('span');

          lbl.textContent = idx;
          lbl.style.right = '10px';
          lbl.classList.add('tab-label');
          tab.appendChild(lbl);
          tab.style.right = r + 'px';
          tab.classList.add('page-tab');
          tab.style.width = 15 + (idx * 30) + 'px';
          tab.style.opacity = opa;
          tab.style.borderRadius = '0px 10px 10px 0px';
          this._pageTabs.appendChild(tab);
          opa -= 0.1;
          r += 30;
        }

        opa = 0.4;
        r   = 0;

        for ( let idx = this._pages.length; idx > 1; idx-- ) {
          let tab = document.createElement('div');
          let lbl = document.createElement('span');

          lbl.textContent = (this._pages.length + 1) - idx;
          lbl.style.left = '10px';
          lbl.classList.add('tab-label');
          tab.appendChild(lbl);
          tab.style.left = r + 'px';
          tab.classList.add('page-tab');
          tab.style.width = 15 + (idx * 30) + 'px';
          tab.style.opacity = opa;
          tab.style.borderRadius = '10px 0px 0px 10px';
          this._pageTabs.appendChild(tab);
          opa -= 0.1;
          r += 30;
        }

      }

      _updateWizardButtons () {
        this._prevButton.disabled = this._pageIndex === 0;
        this._nextButton.disabled = false;
        this._nextButton.icon = (this._pageIndex === this._pages.length - 1) ? 'casper-icons:check-circle' : 'casper-icons:arrow-right';
      }

      _closePage (event) {
        this.close();
      }

      _submitJobResponse (response) {
        if ( response.success === true ) {
          if ( this._jobId ) {
            this.socket.removeEventListener(this._jobId, this._boundJobNotification);
          }
          this._jobId = response.channel;
          this.socket.addEventListener(this._jobId, this._boundJobNotification);
        }
      }

      _onJobNotification (event) {
        this._updateUI(event.detail);
      }

      _updateUI (notification) {

        console.log(notification);

        switch (notification.status) {
          case 'in-progress':
            this.showProgressPage();
            this._progressPage.updateProgress(notification.index, this.i18n.apply(this, notification.message), notification.progress);
            break;
          case 'completed':
            this._updateWizardButtons();
            if ( typeof this['jobCompletedOnPage' + this._pageIndex] === 'function' ) {
              this['jobCompletedOnPage' + this._pageIndex].apply(this, [notification.message, notification.response]);
            } else {
              if ( this._pageIndex === this._pages.length - 1) {
                this.close();
              } else {
                this._gotoNextPage();
              }
            }
            break;
          case 'failed':
          case 'error':
            if ( typeof this['errorOnPage' + this._pageIndex] === 'function' ) {
              this['errorOnPage' + this._pageIndex].apply(this, [notification]);
            } else {
              this.showStatusPage(notification);
            }
            break;
          default:
            break;
        }
      }

    }

    window.customElements.define(CasperWizard.is, CasperWizard);
  </script>
</dom-module>
