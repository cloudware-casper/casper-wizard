<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-wizard.
  -
  - casper-wizard is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-wizard  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-wizard.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-common-ui/casper-i18n-behavior.html">
<link rel="import" href="../casper-wizard/casper-wizard-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-upload-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-progress-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-status-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-iframe-page.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../iron-fit-behavior/iron-fit-behavior.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../casper-icons/casper-icons.html">

<dom-module id="casper-wizard">
  <template id="wizard-base-template">
    <style>
      :host {
        --background-modal-color: var(--modal-header-color, red);
        --roundie: var(--radius-primary, 10px);
        --slide-time: 0.5s;
        --tab-width: 30px;
      }

      paper-icon-button {
        width: 60px;
        height: 60px;
      }

      paper-icon-button[disabled] {
        color: #888;
      }

      .page-container {
        overflow-x: hidden;
        width: 800px;
        height: 478px;
        background-color: black;
        position: relative;
        border-radius: 0px 0px var(--roundie) var(--roundie);
      }

      .title {
        top: 0px;
        left: 0px;
        background-color: var(--background-modal-color);
        border-radius: var(--radius-primary, 10px) var(--radius-primary, 10px) 0px 0px;
        color: white;
        line-height: 42px;
        height: 42px;
        font-size: 18px;
        font-weight: bold;
        padding: 0px 48px 0px 12px;
        margin: 0px;
        text-overflow: ellipsis;
        position: relative;
        white-space: nowrap;
        overflow: hidden;
      }

      .page-tabs {
        top: 0px;
        left: 0px;
        height: 100%;
        position: absolute;
        background-color: #858585;
        opacity: 0.8;
        border-radius: var(--roundie) var(--roundie) var(--roundie) var(--roundie);
      }

      .page-tab {
        top: 0px;
        position: absolute;
        width: var(--tab-width);
        height: 100%;
        background-color: black;
        font-size: 20px;
        font-weight: bold;
      }

      .tab-label {
        position: absolute;
        bottom: 20px;
        color: #cbcbcb;
        font-weight: bold;
        font-size: 18px;
        z-index: 1;
      }

      .wizard-next-button {
        position: absolute;
        right: 0px;
        bottom: 0px;
        color: var(--primary-color);
        z-index: 4;
      }

      .wizard-previous-button {
        position: absolute;
        right: 50px;
        bottom: 0px;
        color: var(--primary-color);
        z-index: 4;
      }

      .wizard-close-button {
        width: 50px;
        height: 50px;
        position: absolute;
        top: -4px;
        right: 0px;
        color: #FFF;
        z-index: 4;
      }

      .page  {
        top: 0px;
        height: 100%;
        position: absolute;
        -moz-transform: translateZ(0);
        -ms-transform: translateZ(0);
        -o-transform: translateZ(0);
        transform: translateZ(0);
        background-color: var(--surface-color, #000);
      }

      .slidein {
        -moz-transition: transform var(--slide-anim) ease-in-out;
        -webkit-transition: transform var(--slide-time) ease-in-out;
        -o-transition: transform var(--slide-time) ease-in-out;
        transition: transform var(--slide-time) ease-in-out;
      }

      .tabslide {
        -moz-transform: translateZ(0);
        -ms-transform: translateZ(0);
        -o-transform: translateZ(0);
        transform: translateZ(0);
        -moz-transition: left 0.3s ease-in-out;
        -webkit-transition: left 0.3s ease-in-out;
        -o-transition: left 0.3s ease-in-out;
        transition: left 0.3s ease-in-out;
      }

      .fadein {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }

      .left {
        transform: translate3d(-100%, 0, 0);
      }

      .right {
        transform: translate3d(100%, 0, 0);
      }
    </style>

    <div class="page-tabs tabslide"></div>
    <div class="title"></div>
    <div class="page-container"></div>
    <paper-icon-button class="wizard-previous-button" icon="casper-icons:arrow-left"></paper-icon-button>
    <paper-icon-button class="wizard-next-button"     icon="casper-icons:arrow-right"></paper-icon-button>
    <paper-icon-button class="wizard-close-button"    icon="casper-icons:close"></paper-icon-button>
  </template>

  <script>
    /**
     * `casper-wizard`
     * Wizard a container for simple dialogs with the infamous prev-next buttons
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperWizard extends Polymer.mixinBehaviors([Polymer.IronOverlayBehavior, Polymer.IronFitBehavior], Casper.I18n(Polymer.Element)) {

      static get is () {
        return 'casper-wizard';
      }

      static get tab_opacity () {
        return 0.3;
      }

      /**
       *
       */
      ready () {
        super.ready();

        // ... inject the base class template into the component ...
        this.shadowRoot.appendChild(CasperWizard.template.content.cloneNode(true));

        // ... make sure all existing pages get the 'page' class
        for ( let page of this.shadowRoot.children ) {
          if ( page instanceof CasperWizardPage ) {
            page.classList.add('page');
          }
        }

        // ... collect the active wizard pages ...
        this._pages = [];
        let pageIdList = null;
        if ( typeof this.activePagesIds === 'function' ) {
          pageIdList = this.activePagesIds();
        }
        if ( pageIdList ) {
          // ... use the explict page list ...
          for ( let id of pageIdList ) {
            this._pages.push(this.$[id]);
          }
        } else {
          // ... grab all children that extend casper-wizard-page ...
          for ( let page of this.shadowRoot.children ) {
            if ( page instanceof CasperWizardPage ) {
              this._pages.push(page);
            }
          }
        }

        // ... keep handdy pointers to the template elements ...
        this._pageTabs = this.shadowRoot.querySelector('.page-tabs');
        this._title = this.shadowRoot.querySelector('.title');
        this._pageContainer = this.shadowRoot.querySelector('.page-container');
        this._prevButton  = this.shadowRoot.querySelector('.wizard-previous-button');
        this._nextButton  = this.shadowRoot.querySelector('.wizard-next-button');
        this._closeButton = this.shadowRoot.querySelector('.wizard-close-button');

        // ... move the wizard pages from the wizard into the page container ...
        for ( let page of this._pages ) {
          this._pageContainer.appendChild(page);
        }

        // ... install event handlers ...
        this._boundJobNotification = this._onJobNotification.bind(this);
        this._prevButton.addEventListener('tap', e => this._gotoPreviousPage(e));
        this._nextButton.addEventListener('tap', e => this._gotoNextPage(e));
        this._closeButton.addEventListener('tap', e => this._closePage(e));

        // ... grab constants from CSS ...
        let style = window.getComputedStyle(this);
        this._slideTime = parseFloat(style.getPropertyValue('--slide-time')) * 1000;
        this._tabWidth = parseFloat(style.getPropertyValue('--tab-width'));
        this._roundie = parseFloat(style.getPropertyValue('--roundie'));

        // ... build tabs if they are not surpressed ...
        if ( this.notabs === undefined || this.notabs === false ) {
          this._createTabs();
        }
        this._gotoPage(0);
      }

      //***************************************************************************************//
      //                                                                                       //
      //                      ~~~ API to be used by the Wizards of Oz ~~~                      //
      //                                                                                       //
      //***************************************************************************************//

      setOptions (options) {
        this.options = JSON.parse(JSON.stringify(options));
      }

      setTitle (title) {
        this._title.textContent = title;
      }

      setPageTitle (pageId, title) {
        let pageIndex = this._getIndexOf(pageId);
        if ( pageIndex ) {
          this._pages[pageIndex].pageTitle = title;
        }
      }

      enablePrevious () {
        this._prevButton.disabled = false;
      }

      disablePrevious () {
        this._prevButton.disabled = true;
      }

      enableNext () {
        this._nextButton.disabled = false;
      }

      disableNext () {
        this._nextButton.disabled = true;
      }

      nextPage () {
        if ( this._pageIndex < this._pages.length - 1 ) {
          this._activatePage(this._pageIndex + 1);
        }
      }

      previousPage () {
        if ( this._pageIndex >= 1 ) {
          this._activatePage(this._pageIndex - 1);
        }
      }

      gotoPage (pageId) {
        let pageIndex = this._getIndexOf(pageId);
        if ( pageIndex ) {
          this._gotoPage(pageIndex);
        }
      }

      hideStatusAndProgress () {
        clearTimeout(this._fadeInTimer);

        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
          this._progressPage.style.opacity = 0;
        }
        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
          this._statusPage.style.opacity = 0;
        }
      }

      submitJob (job, timeout) {
        this.showProgressPage();
        job.validity          = timeout;
        job.entity_id         = null;
        job.user_id           = null;
        job.sharded_schema    = null;   // TODO move this to socket
        job.company_schema    = null;
        job.accounting_schema = null;
        job.accounting_prefix = null;
        this.socket.submitJob(job, this._submitJobResponse.bind(this), { validity: timeout, ttr: timeout, timeout: timeout});
      }

      showProgressPage () {
        clearTimeout(this._fadeInTimer);

        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
          this._statusPage.style.opacity = 0.0;
        }

        // ... create page if needed ...
        if ( this._progressPage === undefined ) {
          this._progressPage = document.createElement('casper-wizard-progress-page');
          this._progressPage.title = 'Progresso em curso';
          this._progressPage.classList.add('fadein');
          this._pageContainer.appendChild(this._progressPage);
        }

        // ... show progress page
        this._progressPage.style.zIndex = '3';
        this._progressPage.style.display = 'flex';
        this._fadeInTimer = setTimeout(() => this._progressPage.style.opacity = 1.0, 0.3 * 1000);
        this._prevButton.disabled = false;
        this._nextButton.disabled = true;
      }

      showStatusPage (notification) {
        clearTimeout(this._fadeInTimer);

        // ... hide current pages ...
        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
          this._progressPage.style.opacity = 0.0;
        }
        // ... create page if needed ...
        if ( this._statusPage === undefined ) {
          this._statusPage  = document.createElement('casper-wizard-status-page');
          this._statusPage.classList.add('fadein');
          this._pageContainer.appendChild(this._statusPage);
        }

        // ... set message and or icon ...
        this._statusPage.message = this.i18n.apply(this, notification.message);
        if ( notification.title !== undefined ) {
          this._statusPage.title = notification.title;
        }
        if ( notification.response !== undefined && notification.response.stash_icon !== undefined ) {
          this._statusPage.icon = notification.response.stash_icon;
        }

        // show status page
        this._statusPage.style.zIndex  = '3';
        this._statusPage.style.display = 'flex';
        this._fadeInTimer = setTimeout(() => this._statusPage.style.opacity = 1.0, 0.3 * 1000);
        this._prevButton.disabled = false;
        this._nextButton.disabled = true;
      }

      showMessagePage (notification) {
        clearTimeout(this._fadeInTimer);

        // ... hide current pages ...
        this.hideStatusAndProgress();

        // ... create page if needed ...
        if ( this._messagePage === undefined ) {
          this._messagePage  = document.createElement('casper-wizard-status-page');
          this._messagePage.classList.add('fadein');
          this._pageContainer.appendChild(this._messagePage);
        }

        // ... set message and or icon ...
        this._messagePage.message = this.i18n.apply(this, notification.message);
        if ( notification.title !== undefined ) {
          this._messagePage.title = notification.title;
        }
        if ( notification.response !== undefined && notification.response.stash_icon !== undefined ) {
          this._messagePage.icon = notification.response.stash_icon;
        }

        this.shadowRoot.querySelector('casper-wizard-status-page').$.StatusIcon.style.fill = '#009900';
        
        // show status page
        this._messagePage.style.zIndex  = '3';
        this._messagePage.style.display = 'flex';
        this._fadeInTimer = setTimeout(() => this._messagePage.style.opacity = 1.0, 0.3 * 1000);
      }


      //***************************************************************************************//
      //                                                                                       //
      //                    ~~~ Internals of the underworld implementaion ~~~                  //
      //                                                                                       //
      //***************************************************************************************//

      _gotoPreviousPage (event) {

        if ( this._slideTimeout !== undefined ) {
          return;
        }

        let page = this._pageIndex
        if ( page >= 1 ) {
          page -= 1;
        }
        if ( typeof this['previousOn' + this._pages[this._pageIndex].id] === 'function' ) {
          this['previousOn' + this._pages[this._pageIndex].id].apply(this);
        } else {
          this._activatePage(page);
        }
      }

      _gotoNextPage (event) {

        if ( this._slideTimeout !== undefined ) {
          return;
        }

        if ( this._pageIndex < this._pages.length - 1 ) {
          if ( typeof this['nextOn' + this._pages[this._pageIndex].id] === 'function' ) {
            this['nextOn' + this._pages[this._pageIndex].id].apply(this);
          } else {
            this._activatePage(this._pageIndex + 1);
          }
        } else {
          if ( typeof this['nextOn' + this._pages[this._pages.length - 1].id] === 'function' ) {
            this['nextOn' + this._pages[this._pages.length - 1].id].apply(this);
          } else {
            this.close();
          }
        }
      }

      _showSubmitButton () {
        this._prevButton.style.right = '100px';
        this._submitButton = document.createElement('paper-button');
        this._submitButton.classList.add('wizard-submit-button');
        this._submitButton.textContent = 'Submeter';
        this._pageContainer.appendChild(this._submitButton);
        this._submitButton.addEventListener('tap', e => this._gotoNextPage(e));
      }

      _hideSubmitButton () {
        this._prevButton.style.right = '50px';
        this._submitButton.style.display = 'none';
        this._nextButton.style.display = 'flex';
      }

      _gotoPage (pageIndex) {
        this._pageIndex = pageIndex;
        this._pageTabs.style.left = - this._tabWidth * this._pageIndex + 'px';
        this._adjustPageClasses();
        this._updateWizardButtons();
        this.hideStatusAndProgress();
      }

      _getIndexOf (pageId) {
        let page = this._pageContainer.querySelector('#' + pageId);
        if ( ! page ) {
          return undefined;
        }
        return Array.prototype.indexOf.call(this._pageContainer.children, page);
      }

      _activatePage (pageIndex) {

        this.hideStatusAndProgress();

        this._pages[this._pageIndex].style.opacity = 0.8;

        const page = this._pages[pageIndex];
        page.style.zIndex = '2';
        page.style.opacity = 1.0;
        page.classList.add('slidein');
        page.classList.remove('left');
        page.classList.remove('right');
        this._pageIndex = pageIndex;
        this._pageTabs.style.left = - this._tabWidth * this._pageIndex + 'px';
        this._slideTimeout = setTimeout(() => this._pageSlideTimer(), this._slideTime);
      }

      _pageSlideTimer (event) {
        this._slideTimeout = undefined;
        this._adjustPageClasses();
        this._updateWizardButtons();
      }

      _adjustPageClasses () {
        for ( let idx = 0; idx < this._pages.length; idx++ ) {
          const page = this._pages[idx];

          page.classList.remove('slidein');
          if ( idx <  this._pageIndex ) {
            page.classList.add('left');
            page.style.zIndex = '0';
          } else if ( idx > this._pageIndex ) {
            page.classList.add('right');
            page.style.zIndex = '0';
          } else {
            page.classList.remove('left');
            page.classList.remove('right');
            page.style.zIndex = '1';
          }
        }
      }

      _createTabs () {
        let off  = 0;
        let w    = parseFloat(window.getComputedStyle(this._pageContainer).getPropertyValue('width')) - 2;
        let opa  = CasperWizard.tab_opacity;

        // ... right side tabs ...  
        this._pageTabs.style.width =  w + this._tabWidth * (this._pages.length - 1) + 'px';
        for ( let idx = this._pages.length; idx > 1; idx-- ) {
          let tab = document.createElement('div');
          let lbl = document.createElement('span');

          lbl.textContent = idx;
          lbl.style.right = off + 10 + 'px';
          lbl.classList.add('tab-label');
          this._pageTabs.appendChild(lbl);
          tab.style.right = off + 'px';
          tab.classList.add('page-tab');
          tab.style.width = this._tabWidth / 2 + (idx * this._tabWidth) + 'px';
          tab.style.opacity = opa;
          tab.style.borderRadius = '0px var(--roundie) var(--roundie) 0px';
          this._pageTabs.appendChild(tab);
          off += this._tabWidth;
        }

        // ... left side tabs ...
        off = 0;
        for ( let idx = this._pages.length; idx > 1; idx-- ) {
          let tab = document.createElement('div');
          let lbl = document.createElement('span');

          lbl.textContent = (this._pages.length + 1) - idx;
          lbl.style.left = off + 10 + 'px';
          lbl.classList.add('tab-label');
          this._pageTabs.appendChild(lbl);
          tab.style.left = off + 'px';
          tab.classList.add('page-tab');
          tab.style.width = this._tabWidth/2 + (idx * this._tabWidth) + 'px';
          tab.style.opacity = opa;
          tab.style.borderRadius = 'var(--roundie) 0px 0px var(--roundie)';
          this._pageTabs.appendChild(tab);
          off += this._tabWidth;
        }
      }

      _updateWizardButtons () {
        this._prevButton.disabled = this._pageIndex === 0;
        this._nextButton.disabled = false;
        this._nextButton.icon = (this._pageIndex === this._pages.length - 1) ? 'casper-icons:check-circle' : 'casper-icons:arrow-right';
      }

      _closePage (event) {
        this.close();
      }

      _submitJobResponse (response) {
        if ( response.success === true ) {
          if ( this._jobId ) {
            this.socket.removeEventListener(this._jobId, this._boundJobNotification);
          }
          this._jobId = response.channel;
          this.socket.addEventListener(this._jobId, this._boundJobNotification);
        }
      }

      _onJobNotification (event) {
        this._updateUI(event.detail);
      }

      _updateUI (notification) {

        switch (notification.status) {
          case 'in-progress':
            this.showProgressPage();
            this._progressPage.updateProgress(notification.index, this.i18n.apply(this, notification.message), notification.progress);
            break;
          case 'completed':
            this._updateWizardButtons();
            if ( typeof this['jobCompletedOn' + this._pages[this._pageIndex].id] === 'function' ) {
              this['jobCompletedOn' + this._pages[this._pageIndex].id].apply(this, [notification.status_code, notification.message, notification.response]);
            } else {
              if ( this._pageIndex === this._pages.length - 1) {
                this.close();
              } else {
                this._gotoNextPage();
              }
            }
            break;
          case 'failed':
          case 'error':
            if ( typeof this['errorOn' + this._pages[this._pageIndex].id] === 'function' ) {
              this['errorOn' + this._pages[this._pageIndex].id].apply(this, [notification]);
            } else {
              this.showStatusPage(notification);
            }
            break;
          default:
            break;
        }
      }

    }

    window.customElements.define(CasperWizard.is, CasperWizard);
  </script>
</dom-module>
