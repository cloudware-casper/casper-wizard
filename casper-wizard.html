<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-wizard.
  -
  - casper-wizard is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-wizard  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-wizard.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-common-ui/casper-i18n-behavior.html">
<link rel="import" href="../casper-wizard/casper-wizard-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-upload-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-progress-page.html">
<link rel="import" href="../casper-wizard/casper-wizard-status-page.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../iron-fit-behavior/iron-fit-behavior.html">

<dom-module id="casper-wizard">
  <template>
    <style>
      :host {
        display: block;
      }

      .wizard-next-button {
        position: absolute;
        background-color: red;
        right: 0;
        bottom: 0;
      }

    </style>

      
    <slot></slot>
      
  </template>


  <script>
    /**
     * `casper-wizard`
     * Wizard a container for simple dialogs with the infamous prev-next buttons
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperWizard extends Polymer.mixinBehaviors([Polymer.IronOverlayBehavior, Polymer.IronFitBehavior], Casper.I18n(Polymer.Element)) {
      
      static get is () { 
        return 'casper-wizard'; 
      }

      ready () {
        super.ready();
        // console.log("wizard ready", this);

        let style = document.createElement('style');
        style.type = 'text/css';
        style.innerHTML = `
            .wizard-next-button { 
              position: absolute;
              color: white; 
              background-color: var(--primary-color); 
              right: 12px; 
              bottom: 12px; 
            }
            .wizard-previous-button {
              position: absolute;
              color: white; 
              background-color: var(--primary-color); 
              right: 100px;
              bottom: 12px;
            }
            .wizard-close-button {
              position: absolute;
              top: 0;
              right: 0;
              padding: 12px;
            };`
        this.shadowRoot.appendChild(style);

        this._pageIndex = 0;
        this._boundJobNotification = this._onJobNotification.bind(this);

        this._pages = this.shadowRoot.querySelectorAll('casper-wizard-page');


        this._prevButton = document.createElement('paper-button');
        this._prevButton.textContent = 'previous';
        this._prevButton.raised = true;
        this._prevButton.addEventListener('tap', e => this._gotoPreviousPage(e));
        this._prevButton.classList = 'wizard-previous-button';
        this.shadowRoot.appendChild(this._prevButton);

        this._nextButton = document.createElement('paper-button');
        this._nextButton.textContent = 'next';
        this._nextButton.raised = true;
        this._nextButton.addEventListener('tap', e => this._gotoNextPage(e));
        this._nextButton.classList = 'wizard-next-button';
        this.shadowRoot.appendChild(this._nextButton);

        this._closeButton = document.createElement('a');
        this._closeButton.innerHTML = '<iron-icon icon="casper-icons:cancel"></iron-icon>';
        this._closeButton.addEventListener('tap', e => this._closePage(e));
        this._closeButton.classList = 'wizard-close-button';
        this.shadowRoot.appendChild(this._closeButton);

        this._activatePage(0)
      }

      connectedCallback () {
        super.connectedCallback();
        // console.log("wizard connectedCallback", this);
      }

      //***************************************************************************************//
      //                                                                                       //
      //                      ~~~ API to be used by the Wizards of Oz ~~~                      //
      //                                                                                       //
      //***************************************************************************************//

      nextPage () {
        if ( this._pageIndex < this._pages.length - 1 ) {
          this._activatePage(this._pageIndex + 1);
        }  
      }

      previousPage () {
        if ( this._pageIndex >= 1 ) {
          this._activatePage(this._pageIndex - 1);
        }
      }

      submitJob (job, timeout) {
        job.validity          = timeout;
        job.entity_id         = null;
        job.user_id           = null;
        job.sharded_schema    = null;   // TODO move this to socket
        job.company_schema    = null;
        job.accounting_schema = null; 
        job.accounting_prefix = null;
        this.socket.submitJob(job, this._submitJobResponse.bind(this), { validity: timeout, ttr: timeout, timeout: timeout});
      }

      //***************************************************************************************//
      //                                                                                       //
      //                    ~~~ Internals of the underworld implementaion ~~~                  //
      //                                                                                       //
      //***************************************************************************************//

      _gotoPreviousPage (event) {
        if ( this._statusPage !== undefined && this._statusPage.style.display !== 'none' ) {
          this._activatePage(this._pageIndex);
        } else {
          if ( this._pageIndex >= 1 ) {
            if ( typeof this['previousOnPage' + this._pageIndex] === 'function' ) {
              this['previousOnPage' + this._pageIndex].apply(this);
            } else {
              this._activatePage(this._pageIndex - 1);
            }
          }
        }
      }

      _gotoNextPage (event) {
        if ( this._pageIndex < this._pages.length - 1 ) {
          if ( typeof this['nextOnPage' + this._pageIndex] === 'function' ) {
            this['nextOnPage' + this._pageIndex].apply(this);
          } else {
            this._activatePage(this._pageIndex + 1);
          }
        }
      }

      _activatePage (pageIndex) {
        if ( this._pageIndex !== undefined ) {
          this._pages[this._pageIndex].style.display = 'none';
        }
        this._pageIndex = pageIndex;
        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
        }
        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
        }
        this._pages[this._pageIndex].style.display = 'flex';
      }

      _closePage (event) {
        this.close(this);
      }


      /*showUploadPage () {
        if ( this._uploadPage === undefined ) {
          this._uploadPage = document.createElement('casper-wizard-upload-panel');
          this.shadowRoot.appendChild(this._uploadPage);
        }
        this._pages[this._pageIndex].style.display = 'none';
        this._uploadPage.style.display = 'flex';
      }*/

      showProgressPage () {
        // ... hide current pages ...
        this._pages[this._pageIndex].style.display = 'none';
        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
        }  
        // ... create page if needed ...
        if ( this._progressPage === undefined ) {
          this._progressPage = document.createElement('casper-wizard-progress-page');
          this.shadowRoot.appendChild(this._progressPage);
        }

        // ... show progress page
        this._progressPage.style.display = 'flex';
      }

      showStatusPage (notification) {
        // ... hide current pages ...
        this._pages[this._pageIndex].style.display = 'none';
        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
        }        
        // ... create page if needed ...
        if ( this._statusPage === undefined ) {
          this._statusPage  = document.createElement('casper-wizard-status-page');
          this.shadowRoot.appendChild(this._statusPage);
        }

        // ... set message and or icon ...
        this._statusPage.message = this.i18n.apply(this, notification.message);
        if ( notification.title !== undefined ) {
          this._statusPage.title = notification.title;
        }
        if ( notification.response !== undefined && notification.response.stash_icon !== undefined ) {
          this._statusPage.icon = notification.response.stash_icon;
        }

        // show status page
        this._statusPage.style.display = 'flex';
      }

      _submitJobResponse (response) {
        if ( response.success === true ) {
          if ( this._jobId ) {
            this.socket.removeEventListener(this._jobId, this._boundJobNotification);
          }
          this._jobId = response.channel;
          this.socket.addEventListener(this._jobId, this._boundJobNotification);
        }
      }

      _onJobNotification (event) {
        this._updateUI(event.detail);
      }

      _updateUI (notification) {

        console.log(notification);

        switch (notification.status) {
          case 'in-progress':
            this.showProgressPage();
            this._progressPage.updateProgress(notification.index, this.i18n.apply(this, notification.message), notification.progress);
            break;
          case 'completed':
            if ( typeof this['jobCompletedOnPage' + this._pageIndex] === 'function' ) {
              this['jobCompletedOnPage' + this._pageIndex].apply(this, [notification.message, notification.response]);
            } else {
              // TODO auto close on last page??
            }
            //this._onUploadCompletedCallbackData = { link: notification.link };
            //this._closeDialog();
            break;
          case 'failed':
          case 'error':
            if ( typeof this['errorOnPage' + this._pageIndex] === 'function' ) {
              this['errorOnPage' + this._pageIndex].apply(this, [notification]);
            } else {
              this.showStatusPage(notification);
            }
            break;
          default:
            break;
        }
      }

    }

    window.customElements.define(CasperWizard.is, CasperWizard);
  </script>
</dom-module>
