<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-wizard.
  -
  - casper-wizard is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-wizard  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-wizard.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-common-ui/casper-i18n-behavior.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../iron-fit-behavior/iron-fit-behavior.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../casper-icons/casper-icons.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="casper-wizard-page.html">
<link rel="import" href="casper-wizard-upload-page.html">
<link rel="import" href="casper-wizard-progress-page.html">
<link rel="import" href="casper-wizard-status-page.html">
<link rel="import" href="casper-wizard-iframe-page.html">

<dom-module id="casper-wizard">
  <template>
    <style>

      .wizard-button {
        background-color: var(--primary-color);
      }

      .wizard-button[disabled] {
        background-color: #e0e0e0;
      }

      .wizard-button[disabled] iron-icon {
        border: 0px solid #e0e0e0;
        fill: #ffffff;
      }

      .wizard-container {
        display: grid;
        overflow: hidden;
        background-color: white;
        grid-template-rows: 42px 1fr 60px;
        border-radius: var(--roundie, 10px);
      }

      .wizard-container .header {
        margin: 0;
        color: white;
        height: 42px;
        display: flex;
        padding: 0 12px;
        font-size: 18px;
        overflow: hidden;
        font-weight: bold;
        flex-direction: row;
        align-items: center;
        white-space: nowrap;
        text-overflow: ellipsis;
        justify-content: space-between;
        background-color: var(--primary-color);
      }

      .wizard-container .header .wizard-close-button {
        padding: 0;
        z-index: 4;
        color: #FFF;
        width: 35px;
        height: 35px;
      }

      .wizard-container .page-container {
        width: 100%;
        flex: auto;
        display: flex;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
      }

      .wizard-container .footer-container {
        height: 60px;
        display: flex;
        padding: 10px 10px 10px 20px;
        box-sizing: border-box;
        justify-content: space-between;
      }

      .wizard-container .footer-container > div {
        height: 100%;
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .wizard-container .wizard-tabs {
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        position: absolute;
        background-color: #858585;
        opacity: 0.8;
        z-index: -1;
        border-radius: var(--roundie, 10px);
      }

      .wizard-container .wizard-tabs .wizard-tab {
        top: 0px;
        position: absolute;
        width: var(--tab-width);
        height: 100%;
        background-color: black;
        font-size: 20px;
        font-weight: bold;
        z-index: -1;
      }

      .wizard-container .wizard-tabs .wizard-tab-label {
        position: absolute;
        bottom: 20px;
        color: #cbcbcb;
        font-weight: bold;
        font-size: 18px;
        z-index: 1;
      }

      .wizard-next-button {
        z-index: 4;
        height: 40px;
        min-width: 40px;
        padding: 0;
        border-radius: 20px;
        background-color: var(--primary-color);
        font-size: 14px;
        font-weight: bold;
        -webkit-font-smoothing: antialiased;
        color: white;
      }

      .wizard-icon-next-button {
        width: 40px;
        height: 40px;
        fill: #fff;
      }

      .button-animation {
        -moz-transition: width 0.5s;
        -webkit-transition: width 0.5s;
        -o-transition: width 0.5s;
        -ms-transition: width 0.5s;
        transition: width 0.5s;
      }

      .wizard-text {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      .wizard-previous-button {
        z-index: 4;
        min-width: 40px;
        min-height: 40px;
        padding: 0;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        -webkit-font-smoothing: antialiased;
        background-color: white;
        color: white;
      }

      .wizard-icon-previous-button {
        width: 40px;
        height: 40px;
        border-radius: 20px;
        box-sizing: border-box;
        fill: var(--primary-color);
        border: 2px solid var(--primary-color);
      }

      .page  {
        top: 0;
        opacity: 1;
        height: 100%;
        display: grid;
        grid-template-rows: 42px 1fr;
        position: absolute;
        -moz-transform: translateZ(0);
        -webkit-transform: translateZ(0);
        -o-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        background-color: var(--surface-color, #FFF);
        border-radius: 0px 0px var(--roundie, 10px) var(--roundie, 10px);
      }

      @supports (-ms-ime-align: auto) {
        .page {
          border-radius: 0px 0px 8px 8px;
        }
      }

      .fade-out {
        opacity: 0 !important;
      }

      .fade-in {
        opacity: 1 !important;
      }

      .fade-animation {
        -moz-transition: opacity .75s ease-in-out;
        -webkit-transition: opacity .75s ease-in-out;
        -o-transition: opacity .75s ease-in-out;
        -ms-transition: opacity .75s ease-in-out;
        transition: opacity .75s ease-in-out;
      }

      #footer-slot-container {
        opacity: 0;
        -moz-transition: opacity .75s ease-in-out;
        -webkit-transition: opacity .75s ease-in-out;
        -o-transition: opacity .75s ease-in-out;
        -ms-transition: opacity .75s ease-in-out;
        transition: opacity .75s ease-in-out;
      }

      .slide-in {
        visibility: visible;
        -moz-transition: transform var(--slide-anim) ease-in-out, opacity .75s ease-in-out;
        -webkit-transition: transform var(--slide-time) ease-in-out, opacity .75s ease-in-out;
        -o-transition: transform var(--slide-time) ease-in-out, opacity .75s ease-in-out;
        -ms-transition: transform var(--slide-time) ease-in-out, opacity .75s ease-in-out;
        transition: transform var(--slide-time) ease-in-out, opacity .75s ease-in-out;
      }

      .tabslide {
        -moz-transform: translateZ(0);
        -webkit-transform: translateZ(0);
        -o-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        -moz-transition: left 0.3s ease-in-out;
        -webkit-transition: left 0.3s ease-in-out;
        -o-transition: left 0.3s ease-in-out;
        -ms-transition: left 0.3s ease-in-out;
        transition: left 0.3s ease-in-out;
      }

      .left {
        visibility: hidden;
        transform: translate3d(-100%, 0, 0);
        -moz-transform: translate3d(-100%, 0, 0);
        -webkit-transform: translate3d(-100%, 0, 0);
        -o-transform: translate3d(-100%, 0, 0);
        -ms-transform: translate3d(-100%, 0, 0);
      }

      .right {
        visibility: hidden;
        -moz-transform: translate3d(100%, 0, 0);
        -webkit-transform: translate3d(100%, 0, 0);
        -o-transform: translate3d(100%, 0, 0);
        -ms-transform: translate3d(100%, 0, 0);
        transform: translate3d(100%, 0, 0);
      }

      .hide-button {
        margin-left: 50%;
        z-index: -1;
      }

      #toast {
        --paper-toast-background-color: var(--primary-color);
        --paper-toast-color: white;
        width: 100%;
        font-weight: bold;
        display: inline-flex;
        justify-content: space-between;
        align-items: center;
      }

      #toast[success] {
        --paper-toast-background-color: #4a9a4a;
        --paper-toast-color: white;
      }

    </style>

    <div class="wizard-container">
      <div class="wizard-tabs tabslide"></div>
      <div class="header">
        <div class="title"></div>
        <paper-icon-button class="wizard-close-button" icon="casper-icons:close"></paper-icon-button>
      </div>
      <div class="page-container"></div>
      <div class="footer-container">
        <div id="footer-slot-container"></div>
        <div>
          <paper-button id="wizardPrevButton" class="wizard-button wizard-previous-button button-animation">
            <iron-icon id="wizardPreviousIcon" class="wizard-icon-previous-button" icon="casper-icons:arrow-left"></iron-icon>
          </paper-button>

          <paper-button id="wizardNextButton" class="wizard-button wizard-next-button button-animation">
            <iron-icon id="wizardNextIcon" class="wizard-icon-next-button" icon="casper-icons:arrow-right"></iron-icon>
            <span id="wizardText" class="wizard-text"></span>
          </paper-button>
        </div>
      </div>
    </div>
    <paper-toast id="toast" duration="5000">
      <iron-icon id="closeToast" icon="casper-icons:cancel"/></iron-icon>
    </paper-toast>
  </template>

  <script>
    /**
     * `casper-wizard`
     * Wizard a container for simple dialogs with the infamous prev-next buttons
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperWizard extends Polymer.mixinBehaviors([Polymer.IronOverlayBehavior, Polymer.IronFitBehavior], Casper.I18n(Polymer.Element)) {

      static get is () {
        return 'casper-wizard';
      }

      static get tabOpacity () {
        return 0.3;
      }

      static get fadeInTimeout () {
        return 300;
      }

      static get defaultMaximumHeight() {
        return '90vh';
      }

      static get defaultMaximumWidth() {
        return '90vw';
      }

      static get defaultDimensions() {
        return {
          width:'800px',
          height: '520px'
        };
      }

      get channel () {
        return this._jobChannel;
      }

      /**
       * Constructor, grabs the pages that will be displayed and moves them in the DOM
       */
      ready () {
        super.ready();

        // ... inject the base class template into the component ...
        this.shadowRoot.appendChild(CasperWizard.template.content.cloneNode(true));

        this.style.setProperty('--tab-width', '30px');
        this.style.setProperty('--slide-time', '0.5s');
        this.style.setProperty('--roundie', 'var(--radius-primary, 10px)');

        // ... make sure all existing pages get the 'page' class
        for ( let page of this.shadowRoot.children ) {
          if ( page instanceof CasperWizardPage ) {
            page.classList.add('page', 'slide-in');
          }
        }

        // ... collect the active wizard pages ...
        this._pages = [];
        let pageIdList = null;
        if ( typeof this.activePagesIds === 'function' ) {
          pageIdList = this.activePagesIds();
        }
        if ( pageIdList ) {
          // If the page is not in the list hide it
          for ( let page of this.shadowRoot.children ) {
            if ( page instanceof CasperWizardPage ) {
              if ( ! pageIdList.includes(page.id) ) {
                page.style.display = 'none';
              }
            }
          }
          // ... use the explict page list ...
          for ( let id of pageIdList ) {
            let page = this.$[id];
            this._pages.push(page);
            page.wizard = this;
          }
        } else {
          // ... grab all children that extend casper-wizard-page ...
          for ( let page of this.shadowRoot.children ) {
            if ( page instanceof CasperWizardPage ) {
              this._pages.push(page);
              page.wizard = this;
            }
          }
        }

        // ... keep handy pointers to the template elements ...
        this._title               = this.shadowRoot.querySelector('.title');
        this._wizardTabs          = this.shadowRoot.querySelector('.wizard-tabs');
        this._wizardContainer     = this.shadowRoot.querySelector('.wizard-container');
        this._prevButton          = this.shadowRoot.querySelector('#wizardPrevButton');
        this._nextButton          = this.shadowRoot.querySelector('#wizardNextButton');
        this._closeButton         = this.shadowRoot.querySelector('.wizard-close-button');
        this._pageContainer       = this.shadowRoot.querySelector('.wizard-container .page-container');
        this._footerSlotContainer = this.shadowRoot.querySelector('.wizard-container #footer-slot-container');
        this._state = 'normal';

        // ... move the wizard pages from the wizard into the page container ...
        this._pages.forEach(page => this._pageContainer.appendChild(page));

        // ... install event handlers ...
        this._prevButton.addEventListener('tap', e => this._gotoPreviousPage(e));
        this._nextButton.addEventListener('tap', e => this._gotoNextPage(e));
        this._closeButton.addEventListener('tap', e => this._closePage(e));
        window.addEventListener('resize', e => this._applyDimensions());

        this._setWizardDefaultDimensions();

        // ... grab constants from CSS ...
        let style = window.getComputedStyle(this);
        this._slideTime = parseFloat(style.getPropertyValue('--slide-time')) * 1000;
        this._tabWidth = parseFloat(style.getPropertyValue('--tab-width'));
        this._roundie = parseFloat(style.getPropertyValue('--roundie'));

        // ... build tabs if they are not surpressed ...
        if ( this.notabs === undefined || this.notabs === false ) {
          this._createTabs();
        }

        this._gotoPage(0);

        // ... some options ...
        this.toast = this.shadowRoot.querySelector('#toast');
        this.toast.fitInto = this;
        this.toast.onclick = () => this.toast.close();
        this.closeToastButton = this.shadowRoot.querySelector('#closeToast');
        this.closeToastButton.onclick = () => this.toast.close();
        this.noCancelOnEscKey = false;
        this.noCancelOnOutsideClick = true;
        this._jobId = this._jobChannel = undefined;

        // listen to close event
        this.addEventListener('opened-changed', e => this.___onOpenedChanged(e));
      }

      connectedCallback () {
        super.connectedCallback();

        if (this.options && this.options.job_id) {
          this.subscribeJob(this.options.job_id, 86400);
          if (this.options.progress_count) {
            this._progressPage.setProgressCount(this.options.progress_count, true);
          }
          this._progressPage.updateProgress(0, "Em progresso", NaN);
        }
      }

      //***************************************************************************************//
      //                                                                                       //
      //                      ~~~ API to be used by the Wizards of Oz ~~~                      //
      //                                                                                       //
      //***************************************************************************************//

      setOptions (options) {
        this.options = options;
      }

      setTitle (title) {
        this._title.textContent = title;
      }

      setPageTitle (pageId, title) {
        let pageIndex = this._getIndexOf(pageId);
        if ( pageIndex !== undefined ) {
          this._pages[pageIndex].pageTitle = title;
        }
      }

      enablePrevious () {
        this._prevButton.disabled = false;
      }

      disablePrevious () {
        this._prevButton.disabled = true;
      }

      enableNext () {
        this._nextButton.disabled = false;
      }

      disableNext () {
        this._nextButton.disabled = true;
      }

      nextPage () {
        if ( this._pageIndex < this._pages.length - 1 ) {
          this._activatePage(this._pageIndex + 1);
        }
      }

      previousPage () {
        if ( this._pageIndex >= 1 ) {
          this._activatePage(this._pageIndex - 1);
        }
      }

      gotoPage (pageId) {
        let pageIndex = this._getIndexOf(pageId);
        if ( pageIndex !== undefined ) {
          this._gotoPage(pageIndex);
          let page = this._pages[pageIndex];
          if (page.hasAttribute('next')) {
            this._changeNextButtonToText(page.getAttribute('next'));
          } else {
            this._changeNextButtonToIcon();
          }
        }
      }

      hideStatusAndProgress () {
        clearTimeout(this._fadeInTimer);

        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
          this._progressPage.style.opacity = 0;
          this._progressPage.setProgressCount(1, true);
        }
        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
          this._statusPage.style.opacity = 0;
          this._statusPage.icon = CasperWizardStatusPage.properties.icon.value;
          this._statusPage.message = CasperWizardStatusPage.properties.message.value;
        }
        this._state = 'normal';
        this._nextButton.disabled = false;

        this._footerSlotContainer.classList.add('fade-in');
        this._getCurrentPage().classList.remove('fade-out');
      }

      submitJob (job, timeout, ttr) {
        this.showProgressPage();
        job.validity = timeout;
        this.socket.submitJob(job, this._submitJobResponse.bind(this), { validity: timeout, ttr: ttr === undefined ? timeout : ttr, timeout: timeout});
      }

      subscribeJob (jobId, timeout) {
        this.showProgressPage();
        this.socket.subscribeJob(jobId, this._subscribeJobResponse.bind(this), timeout);
      }

      showProgressPage () {
        if ( this._state === 'show-progress') {
          return;
        }

        clearTimeout(this._fadeInTimer);

        if ( this._statusPage !== undefined ) {
          this._statusPage.style.display = 'none';
          this._statusPage.style.opacity = 0;
        }

        // ... create page if needed ...
        if ( this._progressPage === undefined ) {
          this._progressPage = document.createElement('casper-wizard-progress-page');
          this._progressPage.title = 'Progresso em curso';
          this._progressPage.style.zIndex = 2;
          this._progressPage.style.opacity = 0;
          this._progressPage.style.position = 'absolute';
          this._progressPage.classList.add('fade-animation');
          this._pageContainer.appendChild(this._progressPage);
        }

        // ... show progress page
        this._state = 'show-progress';
        this._prevButton.disabled = false;
        this._nextButton.disabled = true;

        this._fadeInTimer = setTimeout(() => {
          this._progressPage.style.display = 'block';
          this._progressPage.classList.add('fade-in');

          this._footerSlotContainer.classList.remove('fade-in');
          this._getCurrentPage().classList.add('fade-out');
        }, CasperWizard.fadeInTimeout);
      }

      showStatusPage (notification) {
        if ( this._state === 'show-status') {
          return;
        }

        clearTimeout(this._fadeInTimer);

        // ... hide current pages ...
        if ( this._progressPage !== undefined ) {
          this._progressPage.style.display = 'none';
          this._progressPage.style.opacity = 0;
        }
        // ... create page if needed ...
        if ( this._statusPage === undefined ) {
          this._statusPage  = document.createElement('casper-wizard-status-page');
          this._statusPage.style.zIndex = 2;
          this._statusPage.style.opacity = 0;
          this._statusPage.style.position = 'absolute';
          this._statusPage.classList.add('fade-animation');
          this._pageContainer.appendChild(this._statusPage);
        }

        // ... set message and or icon ...
        this._statusPage.message = this.i18n.apply(this, notification.message);
        if ( notification.response !== undefined && notification.response.title !== undefined ) {
          this._statusPage.title = notification.response.title;
        }
        if ( notification.response !== undefined && notification.response.message_icon !== undefined ) {
          this._statusPage.icon = notification.response.message_icon;
          this._statusPage.$.statusIcon.style.fill = notification.response.color_icon;
        }

        // show status page
        this._state = 'show-progress';
        this._prevButton.disabled = false;
        this._nextButton.disabled = true;

        this._fadeInTimer = setTimeout(() => {
          this._statusPage.style.display = 'block';
          this._statusPage.classList.add('fade-in');

          this._footerSlotContainer.classList.remove('fade-in');
          this._getCurrentPage().classList.add('fade-out');
        }, CasperWizard.fadeInTimeout);
      }

      /**
       * Show toast at the bottow of the wizard
       *
       * @param {String} message the text to display.
       * @param {Boolean} success controls the style, false for errors, true for positive messages.
       */
      openToast (message, success) {
        if ( success !== undefined ) {
          if ( success ) {
            this.toast.setAttribute('success', '');
          } else {
            this.toast.removeAttribute('success');
          }
        }
        this.toast.text = message;
        this.toast.open();
      }

      /**
       * Sets the wizard to the specified fixed dimensions.
       *
       * @param {Object} Object that contains the new dimensions that can be specified in px, vh and vw.
       */
      overrideWizardDimensions (dimensions) {
        this.wizardDimensions = {
          width: dimensions.width,
          height: dimensions.height,
        };

        this._applyDimensions();
        this._setWizardTabsDimensions();
      }

      /**
       * Remove a page by its identifier and re-draw the tabs.
       *
       * @param {String} The identifier for the page that needs to be removed.
       */
      removePageById (pageIdentifier) {
        const pageIndex = this._pages.findIndex(page => page.id === pageIdentifier);

        // Disallow the removal of the current page.
        if (this._pageIndex === pageIndex) return;

        this._pages.splice(pageIndex, 1);
        this._createTabs();
        this._setWizardTabsDimensions();

        // Activate the current page to trigger the tabs re-draw.
        this._pageIndex = pageIndex > this._pageIndex
          ? this._pageIndex
          : this._pageIndex - 1;

        this._activatePage(this._pageIndex);
      }

      //***************************************************************************************//
      //                                                                                       //
      //                    ~~~ Internals of the underworld implementaion ~~~                  //
      //                                                                                       //
      //***************************************************************************************//

      _gotoPreviousPage (event) {

        if ( this._slideTimeout !== undefined ) {
          return;
        }

        let page = this._pageIndex
        if ( page >= 1 ) {
          page -= 1;
          if ( typeof this['previousOn' + this._getCurrentPage().id] === 'function' ) {
            this['previousOn' + this._getCurrentPage().id].apply(this);
          } else {
            this._activatePage(page);
          }
        } else {
          if ( typeof this['previousOn' + this._getCurrentPage().id] === 'function' ) {
            this['previousOn' + this._getCurrentPage().id].apply(this);
          }
        }
      }

      _gotoNextPage (event) {

        if ( this._slideTimeout !== undefined ) {
          return;
        }

        if ( this._pageIndex < this._pages.length - 1 ) {
          if ( typeof this['nextOn' + this._getCurrentPage().id] === 'function' ) {
            this['nextOn' + this._getCurrentPage().id].apply(this);
          } else {
            this._activatePage(this._pageIndex + 1);
          }
        } else {
          if ( typeof this['nextOn' + this._pages[this._pages.length - 1].id] === 'function' ) {
            this['nextOn' + this._pages[this._pages.length - 1].id].apply(this);
          } else {
            this.close();
          }
        }
      }

      _gotoNextPageNoHandlers (event) {

        if ( this._slideTimeout !== undefined ) {
          return;
        }

        if ( this._pageIndex < this._pages.length - 1 ) {
          this._activatePage(this._pageIndex + 1);
        } else {
          this.close();
        }
      }

      _changeNextButtonToText (text) {
        this.wizardText     = this.shadowRoot.querySelector('.wizard-text');
        this.wizardNextIcon = this.shadowRoot.querySelector('.wizard-icon-next-button');

        this.wizardText.textContent = text;
        this.wizardText.style.display = 'flex';
        this.wizardNextIcon.style.display = 'none';

        // Apply padding of 20px on both sides.
        const buttonTextWidth = this._calculateTextWidth(this._nextButton, text.toUpperCase());
        setTimeout(() => this._nextButton.style.width = `${buttonTextWidth + 40}px`, 1);
      }

      _changeNextButtonToIcon () {
        this.wizardText     = this.shadowRoot.querySelector('.wizard-text');
        this.wizardNextIcon = this.shadowRoot.querySelector('.wizard-icon-next-button');

        this.wizardText.textContent = '';
        this.wizardText.style.display = 'none';
        this.wizardNextIcon.style.display = 'flex';

        setTimeout(() => this._nextButton.style.width = '40px', 1);
      }

      _gotoPage (pageIndex) {
        this._pageIndex = pageIndex;
        this._wizardTabs.style.left = - this._tabWidth * this._pageIndex + 'px';
        this._updateWizardButtons();
        this.hideStatusAndProgress();
        this._activatePage(pageIndex);
      }

      _getIndexOf (pageId) {
        let page = this._pageContainer.querySelector('#' + pageId);
        if ( ! page ) {
          return undefined;
        }
        return Array.prototype.indexOf.call(this._pageContainer.children, page);
      }

      _activatePage (pageIndex) {
        const previousPageIndex = this._pageIndex;

        this.hideStatusAndProgress();
        this._pageIndex = pageIndex;

        this._pages.forEach((page, pageIndex) => {
          page.style.overflow = 'auto';
          if (pageIndex !== this._pageIndex) {
            // Begin the fading transition and reset the z-index.
            page.style.zIndex = 1;
            page.classList.add('fade-out');
          } else {
            const page = this._getCurrentPage();
            page.style.zIndex = 2;
            page.classList.remove('left', 'right', 'fade-out');
            this._wizardTabs.style.left = - this._tabWidth * this._pageIndex + 'px';
            this._slideTimeout = setTimeout(() => this._pageSlideTimer(), this._slideTime);

            if ( page.hasAttribute('next') ) {
              this._changeNextButtonToText(page.getAttribute('next'));
            } else {
              this._changeNextButtonToIcon();
            }
          }
        });

        if (this._footerSlotContainer.children.length === 1) {
          // If there is already a footer slot element, fade it away and then append the new one.
          this._footerSlotContainer.classList.remove('fade-in');
          setTimeout(() => {
            this._pages[previousPageIndex].appendChild(this._footerSlotContainer.firstChild);
            this._appendFooterSlotElement();
          }, 300);
        } else {
          // If there are no footer slot at the moment, append right away the new one.
          this._appendFooterSlotElement();
        }
      }

      _appendFooterSlotElement () {
        // See if the current page has an element to append to the footer.
        const footerSlot = this._getCurrentPage().querySelector('[slot=footer]');
        if (footerSlot) {
          this._footerSlotContainer.appendChild(footerSlot);
          this._footerSlotContainer.classList.add('fade-in');
        }
      }

      _pageSlideTimer (event) {
        this._slideTimeout = undefined;
        this._adjustPageClasses();
        this._updateWizardButtons();
      }

      _adjustPageClasses () {
        this._pages.forEach((page, pageIndex) => {
          if (pageIndex !== this._pageIndex) {
            const pageClass = pageIndex < this._pageIndex ? 'left' : 'right';
            page.classList.add(pageClass);
          }
        });
      }

      _createTabs () {
        let off  = 0;
        let w    = parseFloat(window.getComputedStyle(this._wizardContainer).getPropertyValue('width')) - 2;
        let opa  = CasperWizard.tabOpacity;

        // ... right side tabs ...
        this._wizardTabs.innerHTML = '';
        this._wizardTabs.style.width =  w + this._tabWidth * (this._pages.length - 1) + 'px';
        for ( let idx = this._pages.length; idx > 1; idx-- ) {
          let tab = document.createElement('div');
          let lbl = document.createElement('span');

          lbl.textContent = idx;
          lbl.style.right = off + 10 + 'px';
          lbl.classList.add('wizard-tab-label');
          this._wizardTabs.appendChild(lbl);
          tab.style.right = off + 'px';
          tab.classList.add('wizard-tab');
          tab.style.width = this._tabWidth / 2 + (idx * this._tabWidth) + 'px';
          tab.style.opacity = opa;
          tab.style.borderRadius = '0px var(--roundie) var(--roundie) 0px';
          this._wizardTabs.appendChild(tab);
          off += this._tabWidth;
        }

        // ... left side tabs ...
        off = 0;
        for ( let idx = this._pages.length; idx > 1; idx-- ) {
          let tab = document.createElement('div');
          let lbl = document.createElement('span');

          lbl.textContent = (this._pages.length + 1) - idx;
          lbl.style.left = off + 10 + 'px';
          lbl.classList.add('wizard-tab-label');
          this._wizardTabs.appendChild(lbl);
          tab.style.left = off + 'px';
          tab.classList.add('wizard-tab');
          tab.style.width = this._tabWidth/2 + (idx * this._tabWidth) + 'px';
          tab.style.opacity = opa;
          tab.style.borderRadius = 'var(--roundie) 0px 0px var(--roundie)';
          this._wizardTabs.appendChild(tab);
          off += this._tabWidth;
        }
      }

      _updateWizardButtons () {
        this._nextButton.icon = (this._pageIndex === this._pages.length - 1) ? 'casper-icons:check-circle' : 'casper-icons:arrow-right';
      }

      _closePage (event) {
        this.close();
      }

      _subscribeJobResponse (response) {
        CasperWizard._normalizeServerResponse(response);
        this._updateUI(response);
      }

      static _normalizeServerResponse (response) {
        let status;

        if ( response.success === undefined ) {
          response.success = true;
        }

        if ( typeof response.status === 'object' ) {
          status = response.status;
        } else {
          status = response;
        }

        if ( status.status_code === undefined ) {
          response.status_code = response.success ? 200 : 500;
        }

        if ( response.status_code !== 200 && !status.message ) {
          if ( status.response ) {
            response.message = ['Erro serviço, detalhe técnico: ' + JSON.stringify(status.response) ];
            response.status = 'error';
          } else {
            response.message = ['Erro desconhecido status por favor tente mais tarde'];
            response.status = 'error';
          }
        }

        if ( status.action === 'redirect' && status.status === 'completed' && response.response === undefined ) {
          response.response = {
            public_link: status.public_link,
            redirect:    status.redirect
          };
          response.message = [ 'Redirect' ];
          response.status = 'completed';
          response.status_code = 200;
        }
      }

      _submitJobResponse (notification) {
        if ( notification.success === true && this._jobId === undefined && notification.id !== undefined ) {
          this._jobId      = notification.id;
          this._jobChannel = notification.channel;
          this.noCancelOnEscKey = true;
        }
        CasperWizard._normalizeServerResponse(notification);
        this._updateUI(notification);
      }

      _updateUI (notification) {
        switch (notification.status) {
          case 'in-progress':
            this.showProgressPage();
            this._progressPage.updateProgress(notification.index, this.i18n.apply(this, notification.message), notification.progress);
            break;
          case 'completed':
            this._updateWizardButtons();
            if ( typeof this['jobCompletedOn' + this._getCurrentPage().id] === 'function' ) {
              this['jobCompletedOn' + this._getCurrentPage().id].apply(this, [notification.status_code, notification.message, notification.response]);
            } else {
              if ( this._pageIndex === this._pages.length - 1) {
                this.close();
              } else {
                this._gotoNextPageNoHandlers();
              }
            }
            this._clearJob();
            break;
          case 'failed':
          case 'error':
            if ( typeof this['errorOn' + this._getCurrentPage().id] === 'function' ) {
              this['errorOn' + this._getCurrentPage().id].apply(this, [notification]);
            } else {
              this.showStatusPage(notification);
            }
            this._clearJob();
            break;
          default:
            break;
        }
      }

      _hideToast () {
        this.toast.close();
      }

      _clearJob () {
        this._jobId     = undefined;
        this._jobChannel = undefined;
        this.noCancelOnEscKey = false;
      }

      _getCurrentPage () {
        return this._pages[this._pageIndex];
      }

      ___onOpenedChanged (event) {
        if ( event.detail.value === false ) {
          for ( let page of this._pages ) {
            if ( page instanceof CasperWizardUploadPage ) {
              page.clear();
            }
          }
          this.hideStatusAndProgress();
          this._gotoPage(0);
          if ( this._jobId !== undefined ) {
            this.socket.cancelJob(this._jobChannel);
          }
          this._clearJob();
        }
      }

      _calculateTextWidth (element, text) {
        if (!this._canvasContext) this._canvasContext = document.createElement('canvas').getContext('2d');

        const elementStyle = window.getComputedStyle(element);

        this._canvasContext.font = `${elementStyle.fontSize} ${elementStyle.fontFamily}`;

        return this._canvasContext.measureText(text).width;
      }

      _setWizardDefaultDimensions () {
        this.wizardDimensions = {
          width: CasperWizard.defaultDimensions.width,
          height: CasperWizard.defaultDimensions.height
        };

        this._applyDimensions();
        this._setWizardTabsDimensions();
      }

      _setWizardTabsDimensions () {
        const containerWidth = parseFloat(window.getComputedStyle(this._wizardContainer).getPropertyValue('width')) - 2;
        this._wizardTabs.style.width = containerWidth + this._tabWidth * (this._pages.length - 1) + 'px';
      }

      _applyDimensions() {
        // Convert the wizard dimensions to numeric values.
        const parsedWidth = this._parseDimension(this.wizardDimensions.width);
        const parsedHeight = this._parseDimension(this.wizardDimensions.height);

        // Check if we can apply the desired dimensions.
        const calculatedWidth = window.innerWidth >= parsedWidth ? `${parsedWidth}px` : CasperWizard.defaultMaximumWidth;
        const calculatedHeight = window.innerHeight >= parsedHeight ? `${parsedHeight}px` : CasperWizard.defaultMaximumHeight;

        this._wizardContainer.style.width = calculatedWidth;
        this._wizardContainer.style.height = calculatedHeight;
        this._pageContainer.style.height = `calc(${calculatedHeight} - 42px - 60px)`;
      }

      _parseDimension(dimension) {
        const dimensionUnit = dimension.trim().slice(-2);

        switch (dimensionUnit) {
          case 'px': return parseFloat(dimension.slice(0, -2));
          case 'vh': return this._convertViewportHeightToPixels(dimension);
          case 'vw': return this._convertViewportWidthToPixels(dimension);
        }
      }

      _convertViewportHeightToPixels(vh) {
        const percentageViewportHeight = parseFloat(vh.replace('vh', '')) / 100;

        return window.innerHeight * percentageViewportHeight;
      }

      _convertViewportWidthToPixels(vw) {
        const percentageViewportWidth = parseFloat(vw.replace('vw', '')) / 100;

        return window.innerWidth * percentageViewportWidth;
      }
    }

    window.customElements.define(CasperWizard.is, CasperWizard);
  </script>
</dom-module>
